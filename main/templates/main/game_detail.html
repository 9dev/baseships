{% extends "base.html" %}

{% block content %}
    <h2>Opponent</h2>
    {% with board_owner='ai' %}
        {% include 'main/snippets/board.html' %}
    {% endwith %}

    <h2>You</h2>
    {% with board_owner='player' %}
        {% include 'main/snippets/board.html' %}
    {% endwith %}

    <h3>Log</h3>
    <div id="log"></div>
{% endblock content %}

{% block body_extra %}
    <script>
        $(function(){
            var color;
            var player_board = {{ player_board|safe }};
            var ai_board = {{ ai_board|safe }};
            var $log = $('#log');

            var states = {
                EMPTY: 0,
                FILLED: 1,
                MISSED: 2,
                HIT: 3
            };

            var colors = {
                0: 'silver',
                1: 'green',
                2: 'white',
                3: 'red',
                4: 'blue'
            };

            var messages = {
                2: 'missed',
                3: 'hit a ship'
            };

            // populate users' boards

            function populate(board, owner) {
                for(var i = 0; i < board.length; ++i) {
                    for (var j = 0; j < board.length; ++j) {
                        color = colors[parseInt(board[i][j])];
                        $('#id_' + owner + 'field_' + i + '_' + j).css('background-color', color);
                    }
                }
            }

            populate(player_board, 'player');
            populate(ai_board, 'ai');

            // set up the log

            function log_ai(state) { log(state, 'Opponent'); }

            function log_player(state) { log(state, 'You'); }

            function log(state, user) {
                $log.append('<p>' + user + ' ' + messages[state] + '!</p>');
            }

            // perform requested move

            function ai_move(cm) {
                color = colors[parseInt(cm.state)];
                $('#id_playerfield_' + cm.x + '_' + cm.y).css('background-color', color);
                log_ai(parseInt(cm.state));
            }

            function move(data, button) {
                button.css('background-color', colors[data.state]);
                log_player(data.state);

                setTimeout(function() {
                    for(var i = 0; i < data.countermoves.length; ++i) {
                        var cm = data.countermoves[i];
                        ai_move(cm);
                    }
                }, 300);
            }

            $('#board_ai').find('button').click(function() {
                var $this = $(this);
                var indexes = JSON.parse($this.val());

                $.ajax({
                    dataType: "json",
                    method: "post",
                    url: '/move',
                    data: {
                        'x': indexes[0],
                        'y': indexes[1],
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) { move(data, $this); }
                });
            });
        });
    </script>
{% endblock body_extra %}